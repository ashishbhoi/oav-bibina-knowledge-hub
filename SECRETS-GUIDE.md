# üîê Complete Secret Generation Guide

## üöÄ Quick Start: One-Command Setup

Generate all required secrets with our automated script:

```bash
# Generate SESSION_SECRET and create environment files
node generate-secrets.js

# This **Production Security Checklist ‚úÖ**

Before going live, verify:

- [ ] All secrets use strong, randomly generated values
- [ ] Database backups are configured
- [ ] **R2 bucket has proper CORS settings configured** (`wrangler r2 bucket cors put`)
- [ ] **R2 CORS origins restricted to production domain** (not wildcard "*")
- [ ] Admin password is changed from default
- [ ] JWT secret is unique and stored securely
- [ ] All environment variables are properly set in Cloudflare Pages
- [ ] Test file upload/download functionality
- [ ] **Test file replacement feature** (upload new file, verify old file is deleted)
- [ ] Verify admin authentication and session management
- [ ] Check all CRUD operations work correctly
- [ ] Confirm collapsible interfaces function properly
- [ ] Test error handling and validation
- [ ] Verify SSL certificates are working
- [ ] Check that sensitive data is properly encryptedate a secure 64-character SESSION_SECRET
# 2. Create .env and .dev.vars files with the secret
# 3. Show you next steps for Cloudflare credentials
```

## üìã Manual Setup Guide

### 1. SESSION_SECRET ‚úÖ **FULLY AUTOMATED**

**What it is**: A secure random string used to sign JWT tokens for user sessions in the complete authentication system.

**Auto-generated by our script**, or use these manual methods:

```bash
# Method 1: Using our automated script (RECOMMENDED)
node generate-secrets.js

# Method 2: Manual one-liner
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Method 3: Online generator (use trusted sources only)
# Visit: https://generate-secret.vercel.app/32
```

**Example**: `17ca4adab1748d4253c17e6f5c51e6c0b7402b1b1e7dc313d1aa580c9dee0ec7`

**Note**: The system uses this for:

- JWT token signing in the admin authentication system
- Session management with automatic expiry
- Secure cookie encryption for login persistence

---

### 2. Cloudflare Account ID üå©Ô∏è **REQUIRED FOR R2 & D1**

**What it is**: Your unique Cloudflare account identifier needed for R2 storage and D1 database access.

**How to get it**:

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. Login to your account
3. Look at the right sidebar ‚Üí **Account ID** is displayed there
4. Copy the value (format: `1234567890abcdef1234567890abcdef`)

**Example**: `a1b2c3d4e5f6789012345678901234567890abcd`

---

### 3. R2 API Credentials ü™£ **REQUIRED FOR FILE SYSTEM**

**What they are**: API credentials for the complete file upload/download system using Cloudflare R2 storage.

**Used by the system for**:

- File upload workflow with progress tracking
- File replacement feature (upload new files, automatically delete old ones)
- Secure download links with pre-signed URLs
- File management operations (edit metadata, delete files)
- Admin file browser with collapsible interface
- Direct browser uploads via R2 pre-signed URLs (requires CORS configuration)

**Step-by-step setup**:

1. **Go to API Tokens page**:
   - Visit: <https://dash.cloudflare.com/profile/api-tokens>
   - Click **"Create Token"**

2. **Create Custom Token**:
   - Click **"Get started"** next to "Custom token"
   - **Token name**: `OAV Knowledge Hub R2 Access`

3. **Set Permissions**:

   ```text
   Account - Cloudflare R2:Edit
   Zone Resources - Include All zones (or specific zone if needed)
   ```

4. **Create the token**:
   - Click **"Continue to summary"**
   - Click **"Create Token"**
   - **IMPORTANT**: Copy and save the token immediately!

5. In your **Pages project environment variables**, add these credentials:

   ```text
   R2_ACCESS_KEY_ID = "your_access_key_id"
   R2_SECRET_ACCESS_KEY = "your_secret_access_key"
   ```

> **üí° Pro tip**: Test the R2 connection by uploading a test file through the admin interface after deployment. The
> system will automatically validate credentials and provide detailed error messages if something's wrong.

---

## üõ†Ô∏è Setting Up Your Environment Files

### Create `.env` file

```bash
# Copy the template
cp .env.example .env

# Edit with your values
# SESSION_SECRET=your-64-character-hex-string-here
# R2_ACCOUNT_ID=your-cloudflare-account-id-here
# R2_ACCESS_KEY_ID=your-access-key-id-here
# R2_SECRET_ACCESS_KEY=your-secret-access-key-here
```

### Create `.dev.vars` file

```bash
# Copy the template
cp .dev.vars.example .dev.vars

# Edit with the same values as .env
```

---

### Quick Setup Script for All Secrets ÔøΩ

Save time with this automated setup script:

```bash
# 1. Clone and setup project
git clone <your-repo>
cd oav-bibina-knowledge-hub
pnpm install

# 2. Create wrangler.toml from template
cp wrangler.jsonc.example wrangler.toml

# 3. Initialize Cloudflare services
npx wrangler d1 create oav-knowledge-hub-db
npx wrangler r2 bucket create oav-knowledge-hub-files

# 3a. Configure R2 CORS for file uploads (REQUIRED for file replacement feature)
npx wrangler r2 bucket cors put oav-knowledge-hub-files --file=r2-cors.json

# 4. Generate JWT secret
node -e "console.log('JWT_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"

# 5. Setup admin credentials
node -e "console.log('ADMIN_USERNAME=admin\nADMIN_PASSWORD=' + require('crypto').randomBytes(16).toString('hex'))"

# 6. Deploy and sync
npm run deploy
npx wrangler d1 execute oav-knowledge-hub-db --file=./database/schema.sql
npx wrangler d1 execute oav-knowledge-hub-db --file=./database/seed.sql
```

---

## ÔøΩüîí Security Best Practices

### ‚úÖ DO

- Generate SESSION_SECRET with 32+ random bytes
- Use different secrets for development and production
- Store production secrets in Cloudflare Pages environment variables
- Rotate secrets regularly (every 6-12 months)
- Keep secrets in a secure password manager
- Test all authentication flows after secret changes
- Use strong admin passwords and change defaults immediately

### ‚ùå DON'T

- Commit `.env` or `.dev.vars` files to Git
- Share secrets in chat, email, or screenshots
- Use weak or predictable secrets
- Reuse secrets across different projects
- Store secrets in code comments
- Leave default admin credentials in production

---

## üöÄ Quick Setup Commands

```bash
# 1. Generate SESSION_SECRET
node generate-secrets.js

# 2. Create environment files
cp .env.example .env
cp .dev.vars.example .dev.vars

# 3. Edit the files with your values
# (Use your favorite text editor)

# 4. Test the setup
pnpm run dev
```

---

## üÜò Troubleshooting

**"SESSION_SECRET not found"**:

- Check that `.env` file exists and has `SESSION_SECRET=your-value`
- Restart your development server after adding the secret
- Verify the secret is exactly 64 hex characters

**"R2 access denied"**:

- Verify your R2 API token has correct permissions
- Check that Account ID matches your Cloudflare account
- Ensure the R2 bucket exists: `wrangler r2 bucket create oav-knowledge-hub-files`
- Test with a simple upload through the admin interface

**"Invalid token format"**:

- SESSION_SECRET should be hex string (64 characters)
- R2 credentials should match the format from Cloudflare dashboard
- JWT_SECRET in production should be different from development

**"Admin login not working"**:

- Verify ADMIN_USERNAME and ADMIN_PASSWORD are set correctly
- Check that database has been seeded with admin user
- Ensure session cookies are being set properly

---

### Production Security Checklist ‚úÖ

Before going live, verify:

- [ ] All secrets use strong, randomly generated values
- [ ] Database backups are configured
- [ ] R2 bucket has proper CORS settings
- [ ] Admin password is changed from default
- [ ] JWT secret is unique and stored securely
- [ ] All environment variables are properly set in Cloudflare Pages
- [ ] Test file upload/download functionality
- [ ] Verify admin authentication and session management
- [ ] Check all CRUD operations work correctly
- [ ] Confirm collapsible interfaces function properly
- [ ] Test error handling and validation
- [ ] Verify SSL certificates are working
- [ ] Check that sensitive data is properly encrypted

**üéâ Your OAV Bibina Knowledge Hub is now ready for production!**
